version: 2

workflows:
  version: 2
  master:
    jobs:
      - build:
          context: production
          filters:
              branches:
                only:
                  - production
      - build_develop:
          context: develop
          filters:
              branches:
                only:
                  - develop
      - check:
          context: production
          requires:
            - build
          ilters:
              branches:
                only:
                  - production
      - check_develop:
          context: develop
          requires:
            - build_develop
          ilters:
              branches:
                only:
                  - develop
      - image_develop:
          context: develop
          requires:
            - check_develop
          filters:
            branches:
              only:
                - develop
      - image_production:
          context: production
          requires:
            - check
          filters:
            branches:
              only:
                - main
      - deploy_to_develop:
          context: develop
          requires:
            - image_develop
          filters:
            branches:
              only:
                - develop
      - deploy_to_production:
          context: production
          requires:
            - image_production
          filters:
            branches:
              only:
                - main

jobs:
  build:
    docker:
      - image: node:16
    steps:
      - checkout
      - run:
          name: Install packages
          command: yarn install
      - run:
          name: Build project
          command: yarn build
      - persist_to_workspace:
          root: /root/project
          paths:
            - node_modules

  build_develop:
    docker:
      - image: node:16
    steps:
      - checkout
      - run:
          name: Install packages
          command: yarn install
      - run:
          name: Build project
          command: yarn build:beta
      - persist_to_workspace:
          root: /root/project
          paths:
            - node_modules

  check:
    docker:
      - image: node:16
    steps:
      - checkout
      - attach_workspace:
          at: /root/project
      - run:
          name: Check project
          command: yarn ci

  check_develop:
    docker:
      - image: node:16
    steps:
      - checkout
      - attach_workspace:
          at: /root/project
      - run:
          name: Check project
          command: yarn ci

  image_develop:
    machine: true
    steps:
      - checkout
      - run:
          name: Docker login
          command: docker login -u ${REGISTRY_LOGIN} -p ${REGISTRY_PASSWORD} ${REGISTRY_HOST}
      - run:
          name: Build docker image
          command: docker build -t envoys-frontend .
      - run:
          name: Publish docker image
          command: |
            echo "Build number: ${CIRCLE_BUILD_NUM}"
            docker tag envoys-frontend "registry.beta.envoys.vision/envoys-frontend:develop-${CIRCLE_BUILD_NUM}"
            docker push "registry.beta.envoys.vision/envoys-frontend:develop-${CIRCLE_BUILD_NUM}"

  image_production:
    machine: true
    steps:
      - checkout
      - run:
          name: Docker login
          command: docker login -u ${REGISTRY_LOGIN} -p ${REGISTRY_PASSWORD} ${REGISTRY_HOST}
      - run:
          name: Build docker image
          command: docker build -t envoys-frontend .
      - run:
          name: Publish docker image
          command: |
            echo "Build number: ${CIRCLE_BUILD_NUM}"
            docker tag envoys-frontend "registry.app.envoys.vision/envoys-frontend:production-${CIRCLE_BUILD_NUM}"
            docker push "registry.app.envoys.vision/envoys-frontend:production-${CIRCLE_BUILD_NUM}"

  deploy_to_develop:
    docker:
      - image: bash:5-alpine3.15
    steps:
      - checkout
      - run:
          name: Install cURL
          command: apk add curl
      - run:
          name: Run deploy
          command: ./.circleci/deploy.sh "${STACK_FRONTEND}" "${CIRCLE_PREVIOUS_BUILD_NUM}"

  deploy_to_production:
    docker:
      - image: bash:5-alpine3.15
    steps:
      - checkout
      - run:
          name: Install cURL
          command: apk add curl
      - run:
          name: Run deploy
          command: ./.circleci/deploy.sh "${STACK_FRONTEND}" "${CIRCLE_PREVIOUS_BUILD_NUM}"
